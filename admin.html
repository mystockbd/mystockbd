<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel ‚Äî MyStockBD</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin:0; padding:0; }
html, body { height:100%; font-family:'Poppins',sans-serif; background:#f0f9ff; display:flex; justify-content:center; align-items:center; }
body { overflow:hidden; }
.container { width:95%; max-width:1000px; height:95vh; background:white; padding:25px; border-radius:15px; box-shadow:0 10px 40px rgba(0,0,0,0.12); display:flex; flex-direction:column; overflow:hidden; }
.scroll-area { overflow-y:auto; flex:1; padding-right:5px; }
h2 { text-align:center; color:#0ea5e9; margin-bottom:20px; font-size:1.7rem; }
input { width:100%; padding:0.9rem; margin-bottom:1rem; border:1px solid #ccc; border-radius:10px; font-size:1rem; transition:0.3s; }
input:focus { border-color:#0ea5e9; outline:none; }
button { padding:0.8rem 1.5rem; border:none; border-radius:10px; background:#0ea5e9; color:white; cursor:pointer; font-weight:600; transition:0.3s; }
button:hover { background:#0284c7; }
.error-msg { color:red; font-size:0.95rem; margin-bottom:1rem; text-align:center; }
.table-container { overflow-x:auto; margin-top:10px; max-height:50vh; }
.table { width:100%; border-collapse:collapse; min-width:600px; }
.table th, .table td { border:1px solid #ddd; padding:12px; text-align:left; font-size:14px; white-space:nowrap; }
.table th { background:#0ea5e9; color:#fff; position: sticky; top:0; z-index:1; }
.approve-btn{ background:#4caf50; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin-right:4px; transition:0.2s;}
.approve-btn:hover{background:#45a049;}
.reject-btn{background:#f44336; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; transition:0.2s;}
.reject-btn:hover{background:#e53935;}
.status{ font-weight:600; }
@media (max-width:1024px){ h2{ font-size:1.5rem; } input{ font-size:0.95rem; padding:0.8rem; } button{ padding:0.7rem 1.2rem; font-size:0.95rem; } .table th, .table td{ font-size:13px; padding:10px; } }
@media (max-width:768px){ h2{ font-size:1.3rem; } input{ font-size:0.9rem; padding:0.7rem; } button{ padding:0.6rem 1rem; font-size:0.9rem; } .table th, .table td{ font-size:12px; padding:8px; } }
@media (max-width:480px){ .container{ padding:15px; } h2{ font-size:1.1rem; } input{ font-size:0.85rem; padding:0.6rem; } button{ padding:0.5rem 0.9rem; font-size:0.85rem; } .table th, .table td{ font-size:11px; padding:6px; } .table-container { max-height:60vh; } }
</style>
</head>
<body>

<div class="container">
  <h2>Admin Panel</h2>
  
  <!-- Login Form -->
  <div id="loginDiv">
    <div class="error-msg" id="loginError"></div>
    <input type="email" id="email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
    <input type="password" id="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
    <button id="loginBtn">Login</button>
  </div>

  <!-- Pending Sellers Table -->
  <div id="adminDiv" style="display:none;">
    <div class="scroll-area">
      <h2>üìã Pending Seller Requests</h2>
      <div class="table-container">
        <table class="table" id="requestTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Created At</th>
              <th>Status / Countdown</th>
              <th>Method</th>
              <th>Number</th>
              <th>TNX</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <button id="logoutBtn" style="margin-top:10px;">Logout</button>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCvU3TKoohJJZzDCfmRBWsMdRgANGTbQlI",
  authDomain: "mystockbd-3a3a5.firebaseapp.com",
  projectId: "mystockbd-3a3a5",
  storageBucket: "mystockbd-3a3a5.appspot.com",  // ‚úÖ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ".app" ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá ".appspot.com" ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá
  messagingSenderId: "50827837653",
  appId: "1:50827837653:web:7c38c1c4bf3d5f7c82225c",
  measurementId: "G-2SFWHJ8B0L"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginDiv = document.getElementById("loginDiv");
const adminDiv = document.getElementById("adminDiv");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginError = document.getElementById("loginError");
const requestTableBody = document.querySelector("#requestTable tbody");

// Login
loginBtn.addEventListener("click", async ()=>{
  loginError.textContent="";
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if(!email || !password){ loginError.textContent="‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®"; return; }

  try{
    const userCredential = await auth.signInWithEmailAndPassword(email,password);
    const uid = userCredential.user.uid;
    const adminDoc = await db.collection("admins").doc(uid).get();
    if(!adminDoc.exists){
      loginError.textContent="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Admin Access ‡¶®‡ßá‡¶á!";
      auth.signOut();
      return;
    }
    showAdminPanel();
  }catch(err){
    loginError.textContent = err.message;
  }
});

// Logout
logoutBtn.addEventListener("click", ()=>{
  auth.signOut();
  loginDiv.style.display="block";
  adminDiv.style.display="none";
});

// Approve seller
function approveSeller(id){
  if(!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶∏‡ßá‡¶≤‡¶æ‡¶∞‡¶ï‡ßá Approve ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;

  db.collection("sellers").doc(id).get().then(doc => {
    const data = doc.data();
    let expiry;

    if(data.method === "trial"){
  expiry = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000); // 3 days for trial
} else {
  expiry = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000); // 30 days for paid sellers
}



    db.collection("sellers").doc(id).set({
        status: "active",
        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        expiryDate: expiry
    }, { merge: true })
    .then(()=>{ 
      alert(data.method === "trial" ? "‚úÖ Trial Seller Approved! 3 ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞‡ßá auto Inactive ‡¶π‡¶¨‡ßá" 
                                    : "‚úÖ Seller Approved! 30 ‡¶¶‡¶ø‡¶® ‡¶™‡¶∞‡ßá auto Inactive ‡¶π‡¶¨‡ßá"); 
    })
    .catch(err=>{ alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: "+err.message); });

  });
}

// Reject seller
function rejectSeller(id){
  if(!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶∏‡ßá‡¶≤‡¶æ‡¶∞‡¶ï‡ßá Reject ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
  db.collection("sellers").doc(id).update({ status:"Rejected" })
    .then(()=>{ alert("‚ùå Seller Rejected!"); })
    .catch(err=>{ alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: "+err.message); });
}

// Countdown for Paid sellers
const timers = {};
function startCountdown(docId, element, expiryDate){
  if(timers[docId]) clearInterval(timers[docId]);
  function updateCountdown(){
    const now = new Date();
    const diff = expiryDate - now;
    if(diff <= 0){
      element.textContent = "Inactive";
      clearInterval(timers[docId]);
      db.collection("sellers").doc(docId).update({status:"Inactive"});
      return;
    }
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    element.textContent = `active (${days}d ${hours}h ${minutes}m ${seconds}s left)`;
  }
  updateCountdown();
  timers[docId] = setInterval(updateCountdown, 1000);
}

// Show admin panel
function showAdminPanel(){
  loginDiv.style.display="none";
  adminDiv.style.display="block";

  db.collection("sellers").orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      requestTableBody.innerHTML="";
      if(snapshot.empty){
        requestTableBody.innerHTML=`<tr><td colspan="8" style="text-align:center;">‡¶ï‡ßã‡¶®‡ßã request ‡¶®‡ßá‡¶á</td></tr>`;
        return;
      }
      snapshot.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement("tr");
        let createdAtText = d.createdAt ? (d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : new Date(d.createdAt).toLocaleString()) : "Unknown";
        let statusText = d.status || "Inactive";
        tr.innerHTML = `
          <td>${d.name||""}</td>
          <td>${d.email||""}</td>
          <td>${createdAtText}</td>
          <td class="status">${statusText}</td>
          <td>${d.method||""}</td>
          <td>${d.senderNumber||""}</td>
          <td>${d.txn||""}</td>
          <td>
            <button class="approve-btn" onclick="approveSeller('${doc.id}')">Approve</button>
            <button class="reject-btn" onclick="rejectSeller('${doc.id}')">Reject</button>
          </td>
        `;
        requestTableBody.appendChild(tr);

        // Countdown only if Paid and expiryDate exists
        if(d.status==="active" && d.expiryDate){
          const statusElem = tr.querySelector(".status");
          const expiry = d.expiryDate.toDate ? d.expiryDate.toDate() : new Date(d.expiryDate);
          startCountdown(doc.id, statusElem, expiry);
        }
      });
    });

  // Real-time expiry check for all Paid sellers (handles all sessions)
  db.collection("sellers").where("status","==","active")
    .onSnapshot(snapshot=>{
      snapshot.forEach(doc=>{
        const data = doc.data();
        if(!data.expiryDate) return;
        const expiry = data.expiryDate.toDate ? data.expiryDate.toDate() : new Date(data.expiryDate);
        if(new Date() >= expiry){
          db.collection("sellers").doc(doc.id).update({status:"Inactive"});
        }
      });
    });
}

// Auto check if logged in
auth.onAuthStateChanged(user=>{
  if(user){
    db.collection("admins").doc(user.uid).get().then(adminDoc=>{
      if(adminDoc.exists){
        showAdminPanel();
      } else {
        loginDiv.style.display="block";
        adminDiv.style.display="none";
        auth.signOut();
      }
    });
  }else{
    loginDiv.style.display="block";
    adminDiv.style.display="none";
  }
});
</script>

</body>
</html>

